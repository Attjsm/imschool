<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Message for Students</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/2.8.1/alpine.js"></script>
    <link rel="stylesheet" href="https://bit.ly/fontiton5" type="text/css" charset="utf-8" />
    <style>
        body {
            font-family: 'line_seed_sans_th';
            margin: 0;
            padding: 0;
        }

        .top-100 {
            top: 100%
        }

        .bottom-100 {
            bottom: 100%
        }

        .max-h-select {
            max-height: 300px;
        }
    </style>
</head>

<body>

    <div class="flex flex-col items-center">
        <div class="w-full md:w-1/2 flex flex-col items-center h-64">
            <div class="w-full px-4">



                <div
                    class="w-full my-2 p-4 text-center bg-white border border-gray-200 rounded-lg shadow sm:p-8 dark:bg-gray-800 dark:border-gray-700">
                    <div class="inline-flex items-center text-center gap-4">
                        <img class="w-10 h-10 rounded-full"
                            src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExdDU0bDJtZWtiZTN1NXVmc3lpYnhzNWl5dXAzYXU0c20xYXAzMmNiMiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/5AtXMjjrTMwvK/giphy.gif"
                            alt="" id="pictureUrl">
                        <div class="font-medium dark:text-white">
                            <div id="displaynamefield">Displayname</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">ผู้ดำเนินการส่งข้อมูล</div>
                        </div>
                    </div>
                    <h5 class="my-2 mb-2 text-3xl font-bold text-gray-900 dark:text-white">โรงเรียนจริยธรรมศึกษามูลนิธิ</h5>
                    <p class="mb-5 text-base text-gray-500 sm:text-lg dark:text-gray-400">ระบบส่ง Push Message</p>
                    <div
                        class="items-center justify-center space-y-4 sm:flex sm:space-y-0 sm:space-x-4 rtl:space-x-reverse">
                        <div onclick="window.open('https://developers.line.biz/flex-simulator/')"
                            class="w-full sm:w-auto bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-gray-300 text-white rounded-lg inline-flex items-center justify-center px-4 py-2.5 dark:bg-gray-700 dark:hover:bg-gray-600 dark:focus:ring-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="me-3 w-7 h-7">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.245 4.5 4.5 0 0 0 8.4-2.245c0-.399-.078-.78-.22-1.128Zm0 0a15.998 15.998 0 0 0 3.388-1.62m-5.043-.025a15.994 15.994 0 0 1 1.622-3.395m3.42 3.42a15.995 15.995 0 0 0 4.764-4.648l3.876-5.814a1.151 1.151 0 0 0-1.597-1.597L14.146 6.32a15.996 15.996 0 0 0-4.649 4.763m3.42 3.42a6.776 6.776 0 0 0-3.42-3.42" />
                            </svg>

                            <div class="text-left rtl:text-right">
                                <div class="mb-1 text-xs">ออกแบบ Flex Message</div>
                                <div class="-mt-1 font-sans text-sm font-semibold">Flex Simulator</div>
                            </div>
                        </div>
                    </div>
                </div>

<!-- /*  ส่วนของการค้นหา */ -->
                <div x-data="selectConfigs()" x-init="fetchOptions()" class="flex flex-col items-center relative my-2">

                    <div class="w-full">
                        <label for="name"
                            class="my-2 font-semibold text-gray-600/100 dark:text-gray-500/100 inline-block pb-2">โปรดเลือกรายชื่อ
                            (userId)</label>
                        <div @click.away="close()" class="p-1 bg-white flex border border-gray-200 rounded">
                            <input x-model="filter" x-transition:leave="transition ease-in duration-100"
                                x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                                @mousedown="open()" @keydown.enter.stop.prevent="selectOption()"
                                @keydown.arrow-up.prevent="focusPrevOption()"
                                @keydown.arrow-down.prevent="focusNextOption()"
                                class="p-1 px-2 appearance-none outline-none w-full text-gray-800" name="userIdb"
                                id="userIdb">
                            <div class="text-gray-300 w-8 py-1 pl-2 pr-1 border-l flex items-center border-gray-200">
                                <button @click="toggle()"
                                    class="cursor-pointer w-6 h-6 text-gray-600 outline-none focus:outline-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <polyline x-show="!isOpen()" points="18 15 12 20 6 15"></polyline>
                                        <polyline x-show="isOpen()" points="18 15 12 9 6 15"></polyline>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div x-show="isOpen()"
                        class="absolute shadow bg-white top-100 z-40 w-full lef-0 rounded max-h-select overflow-y-auto svelte-5uyqqj">
                        <div class="flex flex-col w-full">
                            <template x-for="(option, index) in filteredOptions()" :key="index">
                                <div @click="onOptionClick(index)" :class="classOption(option, index)"
                                    :aria-selected="focusedOptionIndex === index">
                                    <div
                                        class="flex w-full items-center p-2 pl-2 border-transparent border-l-2 relative hover:border-teal-100">
                                        <div class="w-6 flex flex-col items-center">
                                            <div
                                                class="flex relative w-5 h-5 bg-orange-500 justify-center items-center m-1 mr-2 w-4 h-4 mt-1 rounded-full ">
                                                <img class="rounded-full" alt="A" x-bind:src="option.pictureUrl"> </div>
                                        </div>
                                        <div class="w-full items-center flex">
                                            <div class="mx-2 -mt-1"><span x-text="option.DisplayName"></span>
                                                <div class="text-xs truncate w-full normal-case font-normal -mt-1 text-gray-500"
                                                    x-text="option.FullName + '   ' + option.Lastname +'  '+ option.group +'  '+ option.tel"></div>                                            
                                              </div>                                                      
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="name"
                        class="my-2 font-semibold text-gray-600/100 dark:text-gray-500/100 inline-block pb-2">altText</label>
                    <input class="w-full border-gray-200 px-4 py-2 focus:outline-none" type="text" name="alttext"
                        id="alttext" placeholder="โปรดกรอกข้อความก่อนเข้าห้องแชท" />
                </div>
                <div>
                    <label for="name"
                        class="my-4 font-semibold text-gray-600/100 dark:text-gray-500/100 inline-block pb-2">Json
                        Flex</label>
                    <textarea rows="4" class="block p-2.5 w-full border-gray-200 px-4 py-2 focus:outline-none"
                        type="text" name="jsonf" id="jsonf"
                        placeholder="โปรดกรอก Json ที่ออกแบบจาก Flex Simulator"></textarea>
                </div>
                <div class="my-2 flex items-center me-4">
                    <input checked id="redcheckbox" name="redcheckbox" type="checkbox" value="ok"
                        class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500 dark:focus:ring-red-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label for="red-checkbox"
                        class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">ต้องการที่จะแชร์หาเพื่อน หรือ
                        เข้ากลุ่ม</label>
                </div>
                <div>
                    <input class="my-5 w-full bg-green-600 py-2 rounded-md text-white font-bold cursor-pointer"
                        type="button" id="submit" value="ส่ง Push Message" />
                </div>
                <p class="text-center pt-5">
                    ติดต่อฝ่ายบริการ
                    <a href="tel:0987654321" class="text-blue-600 font-bold">098-765-4321</a>
                </p>

            </div>
        </div>
    </div>





    <div id="loading-overlay"
        class="fixed inset-0 bg-gray-500 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbmlqb3hmZjRsdGluZTVyYmNheWpld2hxcms3ZWN0NHIwNHFkaXdtbCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/5uo4BVG7dylULsrs8z/giphy.gif"
            alt="Loading..." class="w-1/2 h-auto">
    </div>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        function selectConfigs() {
            return {
                filter: '',
                show: false,
                selected: null,
                focusedOptionIndex: null,
                options: null,
                close() {
                    this.show = false;
                    this.filter = this.selectedName();
                    this.focusedOptionIndex = this.selected ? this.focusedOptionIndex : null;
                },
                open() {
                    this.show = true;
                    this.filter = '';
                },
                toggle() {
                    if (this.show) {
                        this.close();
                    } else {
                        this.open()
                    }
                },
                isOpen() {
                    return this.show === true
                },
                selectedName() {
                    return this.selected ? this.selected.iduser : this.filter; // User_Id คีย์หลัก ในการค้นหา ต้องเหมือนกับหัวคอลัมในชีต
                },
                classOption(option, index) {
                    const isSelected = this.selected ? (option.iduser == this.selected.iduser) : false;
                    const isFocused = (index == this.focusedOptionIndex);
                    return {
                        'cursor-pointer w-full border-gray-100 border-b hover:bg-blue-50': true,
                        'bg-blue-100': isSelected,
                        'bg-blue-50': isFocused
                    };
                },
                fetchOptions() {
                    fetch('https://opensheet.elk.sh/1hS7cFBAYGHbuKLBdr-iu3orsFyzIDVqvP--5z9UfwEg/user') //แก้ ไอดีชีต/ชื่อชีต
                  
                      .then(response => response.json())
                        .then(data => this.options = data);
                },
                filteredOptions() {
                    return this.options ? this.options.filter(option => {
                        return (option.DisplayName.toLowerCase().indexOf(this.filter.toLowerCase()) > -1) ||
                               (option.FullName.toLowerCase().indexOf(this.filter.toLowerCase()) > -1) ||
                               (option.tel.toLowerCase().indexOf(this.filter.toLowerCase()) > -1)
                    }) : [];
                },
                onOptionClick(index) {
                    this.focusedOptionIndex = index;
                    this.selectOption();
                },
                selectOption() {
                    if (!this.isOpen()) {
                        return;
                    }
                    this.focusedOptionIndex = this.focusedOptionIndex ?? 0;
                    const selected = this.filteredOptions()[this.focusedOptionIndex];
                    if (this.selected && selected && this.selected.iduser == selected.iduser) {
                        this.filter = '';
                        this.selected = null;
                    } else {
                        this.selected = selected;
                        this.filter = this.selectedName();
                    }
                    this.close();
                },
                focusPrevOption() {
                    if (!this.isOpen()) {
                        return;
                    }
                    const optionsNum = Object.keys(this.filteredOptions()).length - 1;
                    if (this.focusedOptionIndex > 0 && this.focusedOptionIndex <= optionsNum) {
                        this.focusedOptionIndex--;
                    } else if (this.focusedOptionIndex == 0) {
                        this.focusedOptionIndex = optionsNum;
                    }
                },
                focusNextOption() {
                    const optionsNum = Object.keys(this.filteredOptions()).length - 1;
                    if (!this.isOpen()) {
                        this.open();
                    }
                    if (this.focusedOptionIndex == null || this.focusedOptionIndex == optionsNum) {
                        this.focusedOptionIndex = 0;
                    } else if (this.focusedOptionIndex >= 0 && this.focusedOptionIndex < optionsNum) {
                        this.focusedOptionIndex++;
                    }
                }
            }
        }

        window.onload = function () {
            const defaultLiffId = "2000605022-Zgyenz8D"; // แก้ LIFF ID
            initializeLiff(defaultLiffId);
        };

        function initializeLiff(defaultLiffId) {
            liff.init({
                liffId: defaultLiffId,
                withLoginOnExternalBrowser: true,
            })

            liff.ready.then(() => {
                document.getElementById('pictureUrl').src = '' + liff.getDecodedIDToken().picture
                document.getElementById('displaynamefield').textContent = '' + liff.getDecodedIDToken().name;

            });



            document.getElementById('submit').addEventListener('click', handleResult);

        }

        function handleResult() {
            var userIdb = document.getElementById('userIdb').value;
            var alttext = document.getElementById('alttext').value;
            var jsonf = document.getElementById('jsonf').value;
            var redcheckbox = document.getElementById('redcheckbox').checked ? "yes" : "no";



            if (userIdb.trim() === '' || alttext.trim() === '' || jsonf.trim() === '') {

                Swal.fire('Error', 'โปรดกรอกข้อมูลให้ครบทุกช่อง', 'error');
                return;
            }




            liff.getProfile()
                .then(profile => {
                    const name = profile.displayName;
                    const userId = profile.userId;
                    const picture = profile.pictureUrl;
                    sendToGoogleSheet(userIdb, alttext, jsonf, redcheckbox, userId, name, picture);
                })
                .catch(err => {
                    console.log("Error", err);
                });
        }



        function sendToGoogleSheet(userIdb, alttext, jsonf, redcheckbox, userId, name, picture) {
            $('#loading-overlay').removeClass('hidden');
//           Web google Script ที่ดีพอยแล้ว $.post('xxx',)
         
            $.post('https://script.google.com/macros/s/AKfycbyG-xttZ6EaREu_PF40U2mQgspNMHogBOWa6hxzYHyBLMy0AMGAW-Rwwe6ds1zFMi0LDw/exec', {
                userIdb: userIdb,
                alttext: alttext,
                jsonf: jsonf,
                redcheckbox: redcheckbox,
                userId: userId,
                name: name,
                picture: picture
            })
                .done(function (response) {
                    $('#loading-overlay').addClass('hidden');
                    if (response.statusCode === 200) {
                        const flexMessage = JSON.parse(response.body);
                        if (redcheckbox == "yes") {
                            liff.shareTargetPicker([flexMessage])
                                .then(function (res) {
                                    if (res) {
                                        Swal.fire('ดำเนินการสำเร็จ', 'คุณได้บันทึก และ Push Msg เรียบร้อยแล้ว', 'success')
                                            .then(() => {
                                                liff.closeWindow();
                                            });
                                    } else {
                                        Swal.fire({
                                            position: "top-end",
                                            icon: "info",
                                            title: "คุณได้ยกเลิกการแชร์ให้เพื่อน",
                                            showConfirmButton: false,
                                            timer: 1500
                                        })
                                    }
                                })
                                .catch(function (error) {
                                    console.log("Something wrong happened");
                                });
                        } else {
                            Swal.fire({
                                position: "top-end",
                                icon: "success",
                                title: "ดำเนินการส่งสำเร็จแล้ว",
                                showConfirmButton: false,
                                timer: 1500
                            }).then(() => {
                                liff.closeWindow();
                            })
                        }
                    }
                })
                .fail(function (error) {
                    Swal.fire('Error', 'มีข้อผิดพลาดในการบันทึกข้อมูล', 'error').then(() => {
                        liff.closeWindow();
                    });

                });
        }
    </script>
</body>

</html>
